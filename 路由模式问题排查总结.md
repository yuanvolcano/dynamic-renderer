# 路由模式问题排查总结

## 问题描述

uniapp H5应用在配置 history 路由模式后，浏览器地址栏仍然显示 `#/`，似乎还在使用 hash 模式。

## 问题原因

1. **版本不匹配**: `@dcloudio/vite-plugin-uni` 版本过旧，与其他依赖版本不兼容
2. **配置不完整**: 缺少强制 history 模式的环境变量配置
3. **缓存问题**: 旧的编译缓存影响新配置生效

## 解决方案

### 1. 统一依赖版本

将所有 `@dcloudio` 相关依赖统一到同一版本：

```bash
pnpm update @dcloudio/vite-plugin-uni@3.0.0-alpha-4070420250630002
```

### 2. 修正 manifest.json 配置

```json
{
  "h5": {
    "router": {
      "mode": "history",
      "base": "/"
    }
  }
}
```

### 3. 增强 vite.config.mts 配置

添加强制 history 模式的环境变量：

```typescript
define: {
  // 强制使用 history 路由模式
  'process.env.UNI_ROUTER_MODE': '"history"',
}
```

### 4. 服务器配置

确保开发服务器支持 history API fallback：

```typescript
server: {
  historyApiFallback: {
    index: '/index.html',
    rewrites: [
      { from: /^\/pages\/.*$/, to: '/index.html' },
      { from: /^\/.*$/, to: '/index.html' },
    ],
  },
}
```

## 测试方法

### 1. 浏览器测试

1. 访问 `http://localhost:3000`
2. 导航到演示页面，观察地址栏是否还有 `#/`
3. 直接访问 `http://localhost:3000/pages/demo/demo` 看是否正常加载
4. 刷新页面，看是否返回 404

### 2. RouterDemo 组件检测

查看 RouterDemo 组件中的路由模式显示：

- 如果显示 "history (无#/)" 则配置成功
- 如果显示 "hash (检测到#/)" 则还需继续调试

### 3. 测试页面功能

访问 `http://localhost:3000/static/test-router.html` 进行完整的路由功能测试。

## 注意事项

1. **清理缓存**: 每次修改配置后都要清理缓存

   ```bash
   rm -rf .vite dist node_modules/.vite
   ```

2. **强制刷新**: 浏览器可能缓存了旧的 JavaScript，使用 Ctrl+F5 强制刷新

3. **部署配置**: 生产环境需要配置 nginx 等服务器支持 history 模式

## 当前状态

- ✅ 依赖版本已统一
- ✅ manifest.json 已配置为 history 模式
- ✅ vite.config.mts 已添加强制配置
- ✅ 开发服务器支持 history fallback
- ✅ 直接访问路径正常返回内容

**请用浏览器访问 `http://localhost:3000` 测试路由是否正确工作，如果仍有问题请告知具体现象。**
