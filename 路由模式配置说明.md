# 路由模式配置说明

## 📋 概述

项目已成功从 **Hash 路由模式**切换到 **History 路由模式**，同时保持对 H5 和微信小程序的兼容性。

## 🔄 路由模式对比

| 特性       | Hash 模式                          | History 模式                     |
| ---------- | ---------------------------------- | -------------------------------- |
| URL 格式   | `https://example.com/#/pages/demo` | `https://example.com/pages/demo` |
| SEO 友好   | ❌ 搜索引擎不识别 # 后内容         | ✅ URL 更加清洁，SEO 友好        |
| 服务器配置 | ✅ 无需特殊配置                    | ❌ 需要配置 fallback             |
| 用户体验   | ⚠️ URL 带 # 号                     | ✅ 更自然的 URL                  |
| 浏览器兼容 | ✅ 所有现代浏览器                  | ✅ IE10+ 支持                    |

## ⚙️ 配置详情

### 1. pages.json 配置

```json
{
  "h5": {
    "router": {
      "mode": "history",
      "base": "/"
    },
    "optimization": {
      "treeShaking": {
        "enable": true
      }
    },
    "devServer": {
      "https": false
    }
  }
}
```

### 2. vite.config.mts 配置

```typescript
export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, process.cwd(), '');

  return {
    // 配置基础路径
    base: env.VITE_H5_PUBLIC_PATH || '/',

    server: {
      // History API fallback 支持
      historyApiFallback: {
        index: '/index.html',
        rewrites: [
          { from: /^\/pages\/.*$/, to: '/index.html' },
          { from: /^\/.*$/, to: '/index.html' },
        ],
      },
    },
  };
});
```

### 3. 环境变量配置

```bash
# H5 路由基础路径
VITE_H5_ROUTER_BASE=/
VITE_H5_PUBLIC_PATH=/
```

## 🛠️ 路由工具函数

项目提供了完整的跨平台路由工具函数：

### 基础导航

```typescript
import { navigateTo, navigateBack, switchTab } from '@/utils/router';

// 页面跳转
await navigateTo({
  url: '/pages/demo/demo',
  mode: 'push', // push | replace | reLaunch | switchTab
});

// 返回上页
await navigateBack(1);

// Tab 页面切换
await switchTab('/pages/index/index');
```

### 智能导航

```typescript
import { smartNavigate, ROUTES } from '@/utils/router';

// 自动判断是否为 Tab 页面
await smartNavigate(ROUTES.DEMO, { userId: 123 });
```

### URL 处理

```typescript
import { buildUrl, parseUrlQuery, getCurrentRoute } from '@/utils/router';

// 构建 URL
const url = buildUrl('/pages/demo/demo', { type: 'test', id: 123 });

// 解析 URL 参数
const params = parseUrlQuery(url);

// 获取当前路由
const currentPath = getCurrentRoute();
```

## 🌐 部署配置

### Nginx 配置

History 模式需要服务器支持，请使用提供的 `nginx.conf.example` 配置：

```nginx
# 关键配置 - History 路由支持
location / {
    try_files $uri $uri/ /index.html;

    # 防止缓存 index.html
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}
```

### Apache 配置

```apache
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteRule ^index\.html$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.html [L]
</IfModule>
```

### Docker + Nginx

```dockerfile
FROM nginx:alpine
COPY dist/build/h5 /usr/share/nginx/html
COPY nginx.conf.example /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

## 📱 平台兼容性

### H5 端

- ✅ **History 模式** - 使用浏览器 History API
- ✅ **清洁 URL** - 无 # 号的自然路径
- ✅ **SEO 优化** - 搜索引擎友好
- ✅ **前进/后退** - 支持浏览器导航

### 微信小程序端

- ✅ **页面栈管理** - 使用小程序原生导航
- ✅ **Tab 页面** - 自动识别并使用 switchTab
- ✅ **参数传递** - 完整支持 URL 参数
- ✅ **生命周期** - 兼容小程序页面生命周期

## 🎯 使用示例

### 在页面中使用

```vue
<template>
  <view>
    <button @click="goToDemo">前往演示页</button>
    <button @click="goBack">返回</button>
  </view>
</template>

<script setup lang="ts">
import { smartNavigate, navigateBack, ROUTES } from '@/utils/router';

const goToDemo = () => {
  smartNavigate(ROUTES.DEMO, { from: 'home' });
};

const goBack = () => {
  navigateBack();
};
</script>
```

### 路由演示组件

项目包含了完整的路由演示组件 `RouterDemo.vue`，展示了：

- 🏠 Tab 页面切换
- 🔄 History 导航测试
- 📝 带参数跳转
- 🐛 调试信息显示

## 🔍 测试验证

### 开发环境测试

1. **启动开发服务器**：

   ```bash
   pnpm dev:h5:dev
   ```

2. **访问测试**：
   - 首页：`http://localhost:3000/`
   - 演示页：`http://localhost:3000/pages/demo/demo`
   - 带参数：`http://localhost:3000/pages/demo/demo?test=history`

3. **功能测试**：
   - ✅ 直接访问路由路径
   - ✅ 浏览器前进/后退
   - ✅ 刷新页面不报 404
   - ✅ Tab 页面切换
   - ✅ 带参数导航

### URL 格式对比

**Hash 模式（旧）**：

```
http://localhost:3000/#/
http://localhost:3000/#/pages/demo/demo
http://localhost:3000/#/pages/demo/demo?test=hash
```

**History 模式（新）**：

```
http://localhost:3000/
http://localhost:3000/pages/demo/demo
http://localhost:3000/pages/demo/demo?test=history
```

## 🚨 注意事项

### 开发环境

- ✅ Vite 自动配置了 historyApiFallback
- ✅ 支持热重载和路由跳转
- ✅ 开发服务器自动处理 404

### 生产环境

- ⚠️ **必须配置服务器**，否则直接访问路由会 404
- ⚠️ **刷新页面**需要服务器返回 index.html
- ⚠️ **静态资源**路径需要正确配置

### 小程序端

- ✅ 不受影响，仍使用小程序原生导航
- ✅ 路由工具函数自动适配平台
- ✅ 完全兼容现有功能

## 📚 扩展阅读

- [Vue Router History 模式](https://router.vuejs.org/guide/essentials/history-mode.html)
- [uniapp H5 路由模式](https://uniapp.dcloud.net.cn/collocation/pages.html#h5)
- [Nginx Try Files 配置](https://nginx.org/en/docs/http/ngx_http_core_module.html#try_files)

---

**总结**：项目已成功切换到 History 模式，提供了更好的用户体验和 SEO 支持，同时保持了跨平台兼容性。🎉
